<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="scripts/sketchpad.js"></script>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Draw Something Palette</title>
  <style>
    .square {
	  height: 200px;
	  width: 40%;
	}
	.tab {
		padding-left: 40%;
	}
  </style>
</head>

<body>
  <div id="Settings">
    <h3>Draw Something Palette</h3>
    <p> Brush Colour <span class="tab" /> Background Colour</p>
    <input class="square" type="color" id="color-panel"> </input>
    <input class="square" type="color" id="bgcolor-panel"> </input>
    <button class="square" id="line-size-input"> Brush Size </button>
    <input type="number" value="50" id="feedback">
  </div>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<script>

  const socket = io.connect('/palette');

  var line_opasity = 1;
  var line_color = '0,0,0'
  var old_beta = 0;
  var current_beta = 0;
  var line_size = 50;

  document.getElementById('color-panel').oninput = setColor;
  document.getElementById('bgcolor-panel').oninput = setBgColor;
  document.getElementById('line-size-input').ontouchstart = setLineSize;
  document.getElementById('line-size-input').ontouchend = mouseUpLineSize;

  /**
   * Every two seconds, make brush density weaker
   */
  setInterval(function () {
    if (line_opasity >= 0.1) {
      line_opasity = line_opasity - 0.1;
      var line_color_with_opasity = 'rgba(' + line_color + ',' + line_opasity + ')';
      socket.emit('line-color-change', { color: line_color_with_opasity });
    }
  }, 2000);

  /**
   * Sets brush colour
   * @param {event} e - Button Press event
   */
  function setColor(e) {
    line_opasity = 1;
    line_color = hexToRgb(e.target.value)
    var line_color_with_opasity = 'rgba(' + line_color + ',' + line_opasity + ')';
    socket.emit('line-color-change', { color: line_color_with_opasity });
  }

  /**
   * Sets background colour
   * @param {event} e - Button Press event
   */
  function setBgColor(e) {
    socket.emit('bg-color-change', { color: e.target.value });
  }

  /**
   * Converts hex colour string to rgb
   * @param {String} hex - hex string
   */
  function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    if (result) {
      var rgb = parseInt(result[1], 16) + ',' + parseInt(result[2], 16) + ',' + parseInt(result[3], 16);
      return rgb;
    } else {
      return '0,0,0';
    }
  }

  /**
   * Listens to phone orientation to change line size
   * @param {event} e - touch start event
   */
  function setLineSize(e) {
    window.addEventListener("deviceorientation", handleMouseDownSize, true);
  }

  /**
   * Increases or decreases line size
   * @param {event} e - device orientation event
   */
  function handleMouseDownSize(event) {
    current_beta = event.beta;
    if (current_beta - old_beta > 10) {
      line_size = line_size + 10;
      socket.emit('line-size-change', { size: line_size });
      old_beta = current_beta;
      document.getElementById('feedback').value = line_size;
    } else if (old_beta - current_beta > 10 && line_size >= 10) {
      line_size = line_size - 10;
      socket.emit('line-size-change', { size: line_size });
      old_beta = current_beta;
      document.getElementById('feedback').value = line_size;
    }
  }

  /**
   * Stops listening to phone orientation
   * @param {event} e - touch end event
   */
  function mouseUpLineSize(e) {
    window.removeEventListener("deviceorientation", handleMouseDownSize, true);
  }

  window.addEventListener("devicemotion", handleMouseDownShake, true);

  /**
   * Listens to phone acceleration or shake event
   * @param {event} e - acceleration event
   */
  function handleMouseDownShake(event) {
    if (event.acceleration.x > 10) {
      line_opasity = 1;
      var line_color_with_opasity = 'rgba(' + line_color + ',' + line_opasity + ')';
      socket.emit('line-color-change', { color: line_color_with_opasity });
    }
  }

</script>

</html>